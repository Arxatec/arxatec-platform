# Gu√≠a de Testing - Arxatec Platform

Esta gu√≠a explica c√≥mo ejecutar y escribir tests en el proyecto Arxatec Platform siguiendo nuestra arquitectura de features.

## üìã Tabla de Contenidos

- [Configuraci√≥n](#configuraci√≥n)
- [Arquitectura de Tests](#arquitectura-de-tests)
- [Tests Unitarios](#tests-unitarios)
- [Tests E2E](#tests-e2e)
- [Ejecutar Tests](#ejecutar-tests)
- [Estructura de Archivos](#estructura-de-archivos)
- [Mejores Pr√°cticas](#mejores-pr√°cticas)
- [CI/CD](#cicd)

## üõ†Ô∏è Configuraci√≥n

El proyecto est√° configurado con dos tipos principales de testing:

### Tests Unitarios y de Componentes

- **Vitest**: Framework de testing r√°pido y moderno
- **React Testing Library**: Para testing de componentes React
- **Jest DOM**: Matchers adicionales para DOM testing

### Tests End-to-End (E2E)

- **Playwright**: Framework para testing E2E con soporte para m√∫ltiples navegadores
- **Chromium**: Navegador configurado para los tests

## üèóÔ∏è Arquitectura de Tests

Seguimos una arquitectura **co-ubicada** y **por features** para mantener los tests cerca del c√≥digo que prueban:

### 1. Tests por Features

Cada feature tiene su propia carpeta `__tests__/` con tests unitarios y E2E:

```
src/modules/shared/auth/features/
‚îú‚îÄ‚îÄ register/
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ __tests__/              # üëà Tests de la feature
‚îÇ       ‚îú‚îÄ‚îÄ unit/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ components/     # Tests de componentes
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ services/       # Tests de servicios
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ pages/          # Tests de p√°ginas
‚îÇ       ‚îî‚îÄ‚îÄ e2e/
‚îÇ           ‚îî‚îÄ‚îÄ register.spec.ts # Tests E2E
```

### 2. Tests Co-ubicados para Componentes UI

Los componentes UI tienen tests junto al c√≥digo:

```
src/components/ui/
‚îú‚îÄ‚îÄ button/
‚îÇ   ‚îú‚îÄ‚îÄ index.tsx
‚îÇ   ‚îî‚îÄ‚îÄ button.test.tsx         # üëà Test co-ubicado
‚îú‚îÄ‚îÄ input/
‚îÇ   ‚îú‚îÄ‚îÄ index.tsx
‚îÇ   ‚îî‚îÄ‚îÄ input.test.tsx          # üëà Test co-ubicado
```

### 3. Tests de Stores

Los stores de Zustand tienen sus tests co-ubicados:

```
src/store/
‚îî‚îÄ‚îÄ user/
    ‚îú‚îÄ‚îÄ index.ts
    ‚îî‚îÄ‚îÄ __tests__/
        ‚îî‚îÄ‚îÄ user-store.test.ts  # üëà Test del store
```

## üß™ Tests Unitarios

### Ejecutar Tests Unitarios

```bash
# Ejecutar todos los tests unitarios una vez
npm run test:unit

# Ejecutar en modo watch (se re-ejecutan al cambiar archivos)
npm run test:unit:watch

# Ejecutar con coverage
npm run test:unit -- --coverage
```

### Ejemplos de Tests Unitarios

#### Test de Componente UI (Co-ubicado)

```typescript
// src/components/ui/button/button.test.tsx
import { describe, it, expect, vi } from "vitest";
import { render, screen, fireEvent } from "@testing-library/react";
import { Button } from "./index";

describe("Button", () => {
  it("debe renderizar correctamente", () => {
    render(<Button>Haz clic</Button>);
    expect(screen.getByRole("button")).toBeInTheDocument();
  });

  it("debe manejar eventos de clic", () => {
    const handleClick = vi.fn();
    render(<Button onClick={handleClick}>Clic</Button>);

    fireEvent.click(screen.getByRole("button"));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });
});
```

#### Test de Servicio de Feature

```typescript
// src/modules/shared/auth/features/register/__tests__/unit/services/register.test.ts
import { describe, it, expect, vi } from "vitest";
import { register } from "../../../services";
import { axiosInstance } from "@/interceptors";

vi.mock("@/interceptors", () => ({
  axiosInstance: {
    post: vi.fn(),
  },
}));

describe("Register Service", () => {
  it("debe llamar al endpoint correcto", async () => {
    const mockRequest = {
      first_name: "Juan",
      last_name: "P√©rez",
      email: "juan@example.com",
      password: "password123",
    };

    (axiosInstance.post as any).mockResolvedValue({
      data: { data: mockRequest },
    });

    await register(mockRequest);

    expect(axiosInstance.post).toHaveBeenCalledWith(
      "/users/register",
      mockRequest
    );
  });
});
```

#### Test de Store de Zustand

```typescript
// src/store/user/__tests__/user-store.test.ts
import { describe, it, expect, beforeEach } from "vitest";
import { useUserStore } from "../index";

describe("useUserStore", () => {
  beforeEach(() => {
    useUserStore.getState().deleteUser();
  });

  it("debe establecer un usuario correctamente", () => {
    const mockUser = { id: "1", name: "Test User" };

    useUserStore.getState().setUser(mockUser);

    expect(useUserStore.getState().user).toEqual(mockUser);
  });
});
```

## üåê Tests E2E

Los tests E2E est√°n organizados por features y cubren flujos completos de usuario.

### Ejecutar Tests E2E

```bash
# Ejecutar todos los tests E2E
npm run test:e2e

# Ejecutar en modo headed (con interfaz gr√°fica)
npx playwright test --headed

# Ejecutar tests de una feature espec√≠fica
npx playwright test src/modules/shared/auth/features/register/__tests__/e2e/

# Ejecutar en modo debug
npx playwright test --debug
```

### Ejemplo de Test E2E por Feature

```typescript
// src/modules/shared/auth/features/register/__tests__/e2e/register.spec.ts
import { test, expect } from "@playwright/test";

test.describe("Register Feature E2E", () => {
  test.beforeEach(async ({ page }) => {
    await page.goto("/register");
  });

  test("debe completar el flujo de registro", async ({ page }) => {
    // Llenar formulario
    await page.locator('input[id="name"]').fill("Juan");
    await page.locator('input[id="last_name"]').fill("P√©rez");
    await page.locator('input[id="email"]').fill("juan@example.com");
    await page.locator('input[id="password"]').fill("password123");

    // Verificar valores
    await expect(page.locator('input[id="name"]')).toHaveValue("Juan");
    await expect(page.locator('input[id="email"]')).toHaveValue(
      "juan@example.com"
    );

    // Enviar formulario
    await page.getByRole("button", { name: /registrarse/i }).click();
  });
});
```

## üìÅ Estructura de Archivos

```
src/
‚îú‚îÄ‚îÄ components/ui/                    # Componentes UI
‚îÇ   ‚îú‚îÄ‚îÄ button/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ button.test.tsx          # ‚úÖ Test co-ubicado
‚îÇ   ‚îú‚îÄ‚îÄ input/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ input.test.tsx           # ‚úÖ Test co-ubicado
‚îÇ   ‚îî‚îÄ‚îÄ label/
‚îÇ       ‚îú‚îÄ‚îÄ index.tsx
‚îÇ       ‚îî‚îÄ‚îÄ label.test.tsx           # ‚úÖ Test co-ubicado
‚îÇ
‚îú‚îÄ‚îÄ modules/shared/auth/features/     # Features de autenticaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ register/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __tests__/               # ‚úÖ Tests de feature
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ components/      # Tests de componentes
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ services/        # Tests de servicios
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ pages/           # Tests de p√°ginas
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ e2e/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ register.spec.ts # Tests E2E
‚îÇ   ‚îî‚îÄ‚îÄ login/
‚îÇ       ‚îî‚îÄ‚îÄ __tests__/               # ‚úÖ Tests de feature
‚îÇ           ‚îî‚îÄ‚îÄ e2e/
‚îÇ               ‚îî‚îÄ‚îÄ login.spec.ts
‚îÇ
‚îú‚îÄ‚îÄ store/                           # Stores de Zustand
‚îÇ   ‚îî‚îÄ‚îÄ user/
‚îÇ       ‚îú‚îÄ‚îÄ index.ts
‚îÇ       ‚îî‚îÄ‚îÄ __tests__/               # ‚úÖ Tests de store
‚îÇ           ‚îî‚îÄ‚îÄ user-store.test.ts
‚îÇ
‚îî‚îÄ‚îÄ tests/
    ‚îî‚îÄ‚îÄ setup.ts                     # Configuraci√≥n global

# Configuraci√≥n
‚îú‚îÄ‚îÄ playwright.config.ts             # Config Playwright
‚îî‚îÄ‚îÄ vite.config.ts                   # Config Vitest
```

## ‚úÖ Mejores Pr√°cticas

### Tests Unitarios

1. **Co-ubicaci√≥n**: Mant√©n tests cerca del c√≥digo que prueban
2. **Descriptivos**: Nombres claros en espa√±ol que expliquen qu√© se prueba
3. **AAA Pattern**: Arrange, Act, Assert
4. **Mocks**: Usar mocks para dependencias externas
5. **Aislamiento**: Cada test debe ser independiente

```typescript
// ‚úÖ Bueno - Test co-ubicado y descriptivo
describe("RegisterForm", () => {
  beforeEach(() => {
    // Limpiar estado antes de cada test
  });

  it("debe validar email con formato correcto", () => {
    // Arrange
    render(<Form />, { wrapper: RouterWrapper });
    const emailInput = screen.getByLabelText(/correo/i);

    // Act
    fireEvent.change(emailInput, { target: { value: "invalid-email" } });

    // Assert
    expect(emailInput).toBeInvalid();
  });
});
```

### Tests E2E

1. **Por Features**: Organizar tests por funcionalidad
2. **Selectores estables**: Usar `getByRole`, `getByLabelText`, etc.
3. **Esperas expl√≠citas**: Usar `await expect().toBeVisible()`
4. **Datos realistas**: Usar datos que simulen uso real
5. **Flujos completos**: Probar escenarios de usuario completos

```typescript
// ‚úÖ Bueno - Test E2E por feature
test.describe("Login Feature E2E", () => {
  test("debe completar el flujo de login exitoso", async ({ page }) => {
    await page.goto("/login");

    // Llenar credenciales
    await page.locator('input[type="email"]').fill("usuario@ejemplo.com");
    await page.locator('input[type="password"]').fill("password123");

    // Enviar formulario
    await page.getByRole("button", { name: /ingresar/i }).click();

    // Verificar redirecci√≥n exitosa
    await expect(page).toHaveURL("/dashboard");
  });
});
```

### Organizaci√≥n por Features

1. **Separaci√≥n clara**: Unit tests y E2E tests en carpetas separadas
2. **Tests espec√≠ficos**: Cada feature tiene sus propios tests
3. **Reutilizaci√≥n**: Compartir utilities de testing cuando sea apropiado
4. **Mantenimiento**: Tests f√°ciles de encontrar y mantener

## üîÑ CI/CD

Los tests se ejecutan autom√°ticamente en GitHub Actions:

- **Push/PR a main/develop**: Ejecuta todos los tests
- **Tests unitarios**: Se ejecutan en paralelo con lint y build
- **Tests E2E**: Se ejecutan con Playwright en Ubuntu
- **Artefactos**: Se guardan reportes de coverage y Playwright

### Workflow de CI

```yaml
# .github/workflows/tests.yml
jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
      - run: npm ci
      - run: npm run test:unit

  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
      - run: npm ci
      - run: npx playwright install chromium
      - run: npm run test:e2e
```

## üöÄ Comandos R√°pidos

```bash
# Desarrollo
npm run test:unit:watch              # Tests unitarios en modo watch
npx playwright test --ui             # Interfaz web de Playwright

# Tests espec√≠ficos por feature
npm run test:unit src/modules/shared/auth/features/register/
npx playwright test src/modules/shared/auth/features/login/

# CI/Producci√≥n
npm run test:unit                    # Todos los tests unitarios
npm run test:e2e                     # Todos los tests E2E

# Debugging
npx playwright test --debug          # Debug tests E2E
npm run test:unit -- --reporter=verbose  # Tests unitarios verbose
```

## üìä Coverage y Reportes

- **Unit tests**: Coverage autom√°tico con Vitest
- **E2E tests**: Reportes HTML con Playwright
- **CI**: Artefactos guardados en GitHub Actions

Para ver reportes localmente:

```bash
# Coverage unitario
npm run test:unit -- --coverage

# Reporte E2E
npx playwright show-report
```

## üÜò Soluci√≥n de Problemas

### Tests unitarios fallan

- Verificar imports y paths con `@/`
- Revisar setup en `src/tests/setup.ts`
- Limpiar cache: `npm run test:unit -- --run`
- Verificar mocks en tests de features

### Tests E2E fallan

- Verificar que el servidor dev est√© corriendo
- Revisar selectores en los tests
- Usar modo debug: `npx playwright test --debug`
- Verificar rutas y navegaci√≥n

### CI falla

- Revisar logs en GitHub Actions
- Verificar que todas las dependencias est√©n en `package.json`
- Comprobar que los tests pasan localmente

## üìù Convenciones de Naming

### Archivos de Test

- **Componentes UI**: `ComponentName.test.tsx`
- **Services**: `service-name.test.ts`
- **Pages**: `page-name.test.tsx`
- **Stores**: `store-name.test.ts`
- **E2E**: `feature-name.spec.ts`

### Descripciones de Test

```typescript
// ‚úÖ Bueno - Descripciones claras en espa√±ol
describe("RegisterForm", () => {
  it("debe mostrar error cuando el email es inv√°lido", () => {});
  it("debe enviar datos correctamente al hacer submit", () => {});
  it("debe navegar a login despu√©s de registro exitoso", () => {});
});

test.describe("Register Feature E2E", () => {
  test("debe completar el flujo de registro correctamente", async () => {});
  test("debe mostrar errores de validaci√≥n apropiados", async () => {});
});
```

---

## üéØ Resumen

**Ventajas de esta arquitectura:**

‚úÖ **Co-ubicaci√≥n**: Tests cerca del c√≥digo que prueban  
‚úÖ **Organizaci√≥n por features**: F√°cil mantenimiento y escalabilidad  
‚úÖ **Separaci√≥n clara**: Unit tests vs E2E tests bien organizados  
‚úÖ **Reutilizaci√≥n**: Componentes UI testeados independientemente  
‚úÖ **Mantenimiento**: F√°cil encontrar y actualizar tests

¬øTienes preguntas sobre testing? Consulta la documentaci√≥n oficial de [Vitest](https://vitest.dev/) y [Playwright](https://playwright.dev/).
